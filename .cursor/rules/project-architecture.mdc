# 项目架构

## 目录结构

```
ai-drive-system/
├── apps/
│   ├── frontend/          # SvelteKit + shadcn-svelte 前端
│   │   └── src/routes/    # 所有页面直接在此目录下开发
│   └── server/            # Elysia 后端
│       └── src/server/plugins/  # 服务端插件/模块
├── packages/
│   ├── db/                # Drizzle ORM 实体和 TypeBox Schema
│   ├── actions/           # 业务逻辑 Actions
│   └── i18n/              # 国际化翻译
```

---

## 功能扩展开发流程

开发新功能时，按以下步骤在对应位置添加代码：

### 1. 数据库层 (packages/db)

新增数据表在 `packages/db/src/entities/` 下创建：

```
packages/db/src/entities/
├── system/        # 系统模块实体
├── ai/            # AI 模块实体
├── knowledge/     # 知识库实体
└── [新模块]/      # 新模块实体目录
    └── myEntity.ts
```

实体定义规范：
```typescript
// packages/db/src/entities/[module]/myEntity.ts
import { pgTable, uuid, varchar, timestamp } from 'drizzle-orm/pg-core';
import { createTypeboxSchemas } from '../../utils/entity';
import { pkSchema, auditSchema } from '../base';

export const myEntity = pgTable('my_entity', {
  ...pkSchema,
  name: varchar('name', { length: 100 }).notNull(),
  ...auditSchema,
});

// 使用 drizzle-typebox 自动生成 schemas
export const myEntitySchemas = createTypeboxSchemas(myEntity);

// 类型推导
export type MyEntitySelect = typeof myEntity.$inferSelect;
export type MyEntityInsert = typeof myEntity.$inferInsert;
```

### 2. 业务逻辑层 (packages/actions)

新增 Actions 在 `packages/actions/src/db/` 下创建：

```
packages/actions/src/db/
├── system/        # 系统模块 Actions
├── ai/            # AI 模块 Actions
├── knowledge/     # 知识库 Actions
└── [新模块]/      # 新模块 Actions 目录
    └── index.ts
```

Action 定义规范：
```typescript
// packages/actions/src/db/[module]/index.ts
import { defineAction } from '../../core/define';
import { t } from 'elysia';

export const myEntityGetList = defineAction({
  meta: {
    name: 'module.myEntity.getList',
    displayName: '获取列表',
    method: 'POST',
    path: '/api/module/my-entity/query',
  },
  schemas: {
    bodySchema: t.Object({ limit: t.Number({ default: 20 }) }),
    outputSchema: t.Object({ data: t.Array(t.Object({})), total: t.Number() }),
  },
  execute: async (input, context) => {
    // 业务逻辑
    return { data: [], total: 0 };
  },
});

// 导出到 packages/actions/index.ts
```

### 3. 前端页面 (apps/frontend)

页面类型和路由结构：

```
apps/frontend/src/routes/
├── login/                 # 登录页（无 layout）
├── public/                # 公开页面（无需登录，无 dashboard layout）
│   └── [功能]/            # 如门户、落地页等
├── dashboard/             # 后台页面（需登录，有 sidebar layout）
│   ├── +layout.svelte     # dashboard 布局（sidebar + header）
│   ├── system/            # 系统管理
│   ├── ai/                # AI 管理
│   ├── knowledge/         # 知识库
│   └── [新模块]/          # 新功能模块
│       ├── +page.ts       # 页面元数据
│       └── +page.svelte   # 页面组件
└── +layout.svelte         # 根布局
```

页面类型说明：
- `/dashboard/*` - 需要登录，有侧边栏和顶栏的后台页面
- `/public/*` - 不需要登录的公开页面（门户、落地页等）
- `/login` - 登录页

Dashboard 页面示例：
```typescript
// +page.ts
export const _meta = {
  title: '功能名称',
  icon: 'tdesign:app',
  group: '模块分组',
  order: 10,
  permission: 'module:entity:view'
};
```

```svelte
<!-- +page.svelte -->
<script lang="ts">
  import { authStore } from '$lib/stores/auth.svelte';
  
  const api = authStore.createApi(true);
  // ...
</script>
```

公开页面示例（无需登录）：
```
apps/frontend/src/routes/public/landing/+page.svelte  -> /public/landing
apps/frontend/src/routes/public/about/+page.svelte    -> /public/about
```

---

## 禁止使用的模式

- ❌ 不使用 extendApps 插件分包模式
- ❌ 不使用 startApp/removeApp 动态加载
- ❌ 不在独立包中开发前端页面或后端路由

---

## 菜单结构示例

知识库菜单分组：

```
知识库 (KNOWLEDGE) - 目录
├── 我的知识库 (MY_FILES) - /dashboard/knowledge/my-files
├── 收到的共享 (SHARED_WITH_ME) - /dashboard/knowledge/shared-with-me
├── 我的共享 (MY_SHARED) - /dashboard/knowledge/my-shared
└── 收藏 (FAVORITES) - /dashboard/knowledge/favorites
```

菜单种子数据：`packages/db/src/seedData/menu.ts`
角色菜单关联：`packages/db/src/seedData/roleMenu.ts`

---

## packages/db

导出规范：
```typescript
import { createTypeboxSchemas } from '../../utils/entity';

export const tableName = pgTable('table_name', { ... });
export const tableNameSchemas = createTypeboxSchemas(tableName);

// 类型推导
export type TableNameSelect = typeof tableName.$inferSelect;
export type TableNameInsert = typeof tableName.$inferInsert;
```

## packages/actions

ActionContext 包含：
- `currentUserId` - 当前用户 ID（必填）
- `currentUserName` - 当前用户名（必填）

## packages/i18n

翻译文件结构：
- `common.ts` - 通用翻译
- `error.ts` - 错误消息
- `validation.ts` - 验证消息
- `db/*.ts` - 数据库字段翻译

## apps/frontend

auth.svelte.ts 功能：
- Token 管理和自动刷新
- 401 自动重试
- 自动注入审计字段（createdBy, updatedBy）
